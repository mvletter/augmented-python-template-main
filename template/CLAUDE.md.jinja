# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

> **Note**: This is the base CLAUDE.md file included in all services generated from the Python template.
> Do not edit this file directly as it will cause conflicts when running `copier update`.
> Project-specific details, developer preferences, and additional context can be added to separate files. E.g.:
> - `CLAUDE-{{ service_name }}.md` - Project-specific information, business logic, deployment details
> - `CLAUDE-{developer}.md` - Developer-specific preferences, local setup notes, personal workflows
>
> Only `CLAUDE-{{ service_name }}.md` is tracked in git; other `CLAUDE-*.md` files are gitignored.

## Essential Commands

### Quick Start
```bash
# Start everything
docker compose up --build

# Run tests
docker compose run --rm server pytest service

# Check code quality
uvx pre-commit run --all-files
```

### Package Management
This project uses **uv** as the package manager:
- **Install dependencies**: `uv sync` - Installs all dependencies from `pyproject.toml` and `uv.lock`
- **Add a dependency**: `uv add package-name==1.2.3` - Adds to project dependencies
- **Add a dev dependency**: `uv add --dev package-name==1.2.3` - Adds to development dependencies
- **Run one-off tools**: `uvx tool-name` - Runs tools without installing them
  - Example: `uvx ruff check .` or `uvx pre-commit run --all-files`

### Service Management
- **Start all services**: `docker compose up --build`
- **Start in background**: `docker compose up -d --build`
- **View logs**: `docker compose logs -f {{ service_name }}`
- **Stop services**: `docker compose down`
- **Reset everything**: `docker compose down -v && docker compose up --build`
- **Shell into container**: `docker compose exec server bash`
- **Install dependencies**: `uv sync`

### Code Quality
- **Lint and format**: `uvx ruff check . --fix && uvx ruff format .`
- **Pre-commit checks**: `uvx pre-commit run --all-files`

### Testing
- **Run all tests**: `docker compose run --rm server pytest service`
- **With coverage**: `docker compose run --rm server pytest service --cov=service --cov=holo --cov-report=html`
- **Specific test**: `docker compose run --rm server pytest path/to/test_file.py::test_function_name`

{% if include_database %}
### Database Operations
- **Run migrations**: `docker compose exec server alembic upgrade head`
- **Create migration**: `docker compose exec server alembic revision --autogenerate -m "description"`
- **Reset database**: `docker compose down -v db && docker compose up -d db`
- **Connect to database**: `docker compose exec db psql`
- **Show pending migrations**: `docker compose exec server alembic heads`
- **Check migration status**: `docker compose exec server alembic current`

{% endif %}
### Project Setup
- **Verify project setup**: `./scripts/verify_project.sh`
- **Build containers**: `docker compose build`

## Architecture

This service follows Clean Architecture with three main layers:

### Core (`service/core/`)
- **Entities**: Domain models and business rules
- **Use Cases**: Application business logic and orchestration
- Pure business logic with no external dependencies

### Infrastructure (`service/data/`)
{% if include_database %}
- **Models**: SQLAlchemy database models
{% endif %}
{% if include_database or include_redis %}
- **Repositories**: Data access layer implementations
{% if include_database %}
  - Handle database persistence operations
{% endif %}
{% if include_redis %}
  - Handle Redis cache operations
{% endif %}
{% endif %}
- **Connectors**: Connection management for external services
{% if include_database %}
  - Database connection pooling and session management
{% endif %}
{% if include_redis %}
  - Redis connection and client management
{% endif %}
{% if use_nats %}
  - NATS messaging client connections
{% endif %}

### Dependency Injection (`service/injector.py`)
Provides centralized dependency management:
{% if include_database %}
- Database session creation and cleanup
- Automatic commit/rollback handling for database operations
- Use `Depends(db_session, scope="function")` for endpoints with database transactions
{% endif %}
{% if include_redis %}
- Redis connection pooling and client management
- Automatic connection cleanup after use
{% endif %}
{% if use_nats %}
- NATS client connections for messaging
{% endif %}

## Key Patterns & File Locations

### Request Flow
1. **HTTP Layer**: Request arrives at `service/adapters/http/endpoints.py`
2. **Business Logic**: Processed by use cases in `service/core/usecases.py`
{% if include_database or include_redis %}
3. **Data Layer**: Repositories in `service/data/repositories.py` handle persistence
{% endif %}
4. **Response**: Returns up the callstack to the client

Key principle: Use cases contain pure business logic, isolated from infrastructure concerns

### Important Files to Know
- **Main app**: `service/server.py` - FastAPI app configuration
- **Dependencies**: `service/injector.py` - Database sessions{% if include_redis %}, Redis connections{% endif %}
- **Configuration**: `service/config.py` (optional) - Service-specific config overrides
- **Domain logic**: `service/core/` - Entities, use cases, business rules
- **HTTP layer**: `service/adapters/http/` - Endpoints, schemas, HTTP logic
{% if include_database %}
  - Use `Depends(db_session, scope="function")` for database transactions
{% endif %}
{% if use_nats %}
- **NATS layer**: `service/adapters/nats/` - Event handlers and messaging logic
{% endif %}
{% if use_resgate %}
- **Resgate layer**: `service/adapters/resgate/` - Real-time API handlers
{% endif %}
{% if include_database or include_redis %}
- **Data layer**: `service/data/` - Models, repositories and data access implementations
{% endif %}
{% if include_database %}
- **Migrations**: `migrations/versions/` - Alembic database migrations
{% endif %}
- **Commands**: `service/commands/` - CLI commands via `manage.py`
- **Tests**: `service/*/tests/` - Unit and integration tests

## SPEC Workflow

This project uses SPEC-based development for structured feature work.

### Commands

- `/plan "feature description"` - Create SPEC document
- `/implement SPEC-XXX` - Implement SPEC with DDD
- `/sync SPEC-XXX` - Generate docs and create PR

### When to Use

**SPEC workflow (recommended for):**
- Multi-developer features
- Features requiring handoff
- Major architectural changes
- Features >2 days work

**Ad-hoc workflow:**
- Quick bug fixes
- Single-file changes
- Exploratory coding

See `../.shared/workflow/README.md` for full SPEC workflow guide.

## Core Rules

See `../.shared/rules/rules.md` for the 5 core rules (shared across all projects).

## Pitfalls & Patterns

See:
- `../.shared/pitfalls/` - Pitfalls across 7 categories
- `../.shared/patterns/` - Patterns across 3 categories



### Testing Strategy
- Tests are organized by layer in corresponding `tests/` directories
{% if include_database or include_redis %}
- Database and Redis use real connections to test-specific instances during tests
{% endif %}
{% if use_nats %}
- NATS{% if use_resgate %}/Resgate{% endif %} connections are mocked via the `_fake_nats` autouse fixture
- Use `nats_publish`{% if use_resgate %} or `resgate_publish`{% endif %} fixtures to assert on published messages
{% endif %}
- Use `aioresponse` fixture to mock external HTTP calls
- Test data generation uses Polyfactory factories
- Run tests with `docker compose run --rm server pytest service`
{% if include_database %}
- Database migrations are tested manually using `alembic upgrade head` and `alembic downgrade`
{% endif %}

### Configuration Files
- **Environment**: `.env.dev.override` - Local development overrides
- **Docker**: `docker-compose.override.yml` - Local Docker overrides
- **Dependencies**: `pyproject.toml` - Python packages and tool config
- **Config classes**: `service/config.py` - Optional project specific configuration
- Access configuration through namespaced objects:
  - `config.service.*` - Service-specific settings
{% if include_database %}
  - `config.database.*` - Database connection settings
{% endif %}
{% if include_redis %}
  - `config.redis.*` - Redis cache configuration
{% endif %}
{% if use_nats %}
  - `config.nats.*` - NATS messaging settings
{% endif %}

### Error Handling & Logging
- **Domain exceptions**: `holo/core/exceptions.py` - Base exception classes for business logic errors
- **HTTP errors**: `holo/adapters/http/exceptions.py` - HTTPException with error_code mapping
- **Logging**: Structured JSON logs with trace IDs for request tracking
- **Monitoring**: Health endpoints at `/health`, `/ping`, `/metrics`

## Monitoring Endpoints

- **Health check**: `GET /health` - Service and dependency health
- **Ping**: `GET /ping` - Basic connectivity test
- **Metrics**: `GET /metrics` - Prometheus metrics
{% if include_database %}
- **Debug SQL**: `GET /debug/sql` - SQL query monitoring (if enabled)
{% endif %}

## Common Tasks

### Adding a New Feature
- Define entities in `service/core/entities.py`
- Create use case in `service/core/usecases.py`
{% if include_database %}
- Add repository methods in `service/data/repositories.py`
{% endif %}
- Create HTTP endpoints in `service/adapters/http/endpoints.py`
- Add tests for each layer

{% if include_database %}
### Database Changes
1. Modify models in `service/data/models.py`
2. Generate migration: `docker compose exec server alembic revision --autogenerate -m "description"`
3. Review and edit migration file
4. Apply migration: `docker compose exec server alembic upgrade head`

{% endif %}
### Adding Commands
1. Create command in `service/commands/`
2. Implement business logic in use cases
3. Run with: `docker compose exec server python manage.py command_name`
4. Can be scheduled via crontab in `helm/values.yaml` for automated execution

{% if use_nats %}
### NATS Event Handling
1. Create subfolder in `service/adapters/nats/{topic}/` for logical grouping
2. Define events in `{topic}/events.py`
3. Create handlers in `{topic}/handlers.py`
4. Register handlers in `service/nats.py` by adding to the `subscribers` list

{% endif %}
{% if include_redis %}
### Redis Operations
- **Connect to Redis**: `docker compose exec redis redis-cli`
- **Monitor Redis**: `docker compose exec redis redis-cli monitor`
- **Clear cache**: `docker compose exec redis redis-cli flushall`

{% endif %}
## Docker Services

The `docker-compose.yml` includes:
- **{{ service_name }}**: Main application service
{% if include_database %}
- **db**: PostgreSQL database
{% endif %}
{% if include_redis %}
- **redis**: Dragonfly (Redis-compatible cache)
{% endif %}

Use `docker compose ps` to see all running services.
