import logging
from collections.abc import Awaitable, Callable
from functools import wraps
from typing import Any, ParamSpec, TypeVar

from opentelemetry import trace
from redis.asyncio.client import Redis
from sqlalchemy.ext.asyncio.session import AsyncSession

from holo.config import config
{% if use_nats %}
from holo.nats.client import HoloNats
{% endif %}


T = TypeVar("T")
P = ParamSpec("P")


class TraceCallMeta(type):
    def __new__(cls, name: str, bases: tuple[type, ...], attrs: dict[str, Any]) -> type:
        if "__call__" in attrs:
            tracer = trace.get_tracer(name)

            def traced(func: Callable[P, Awaitable[T]]) -> Callable[P, Awaitable[T]]:
                @wraps(func)
                async def wrapper(*args: P.args, **kwargs: P.kwargs) -> T:
                    with tracer.start_as_current_span(f"USECASE {name}", kind=trace.SpanKind.INTERNAL):
                        return await func(*args, **kwargs)

                return wrapper

            if config.service.TRACING and not config.service.TESTING:
                attrs["__call__"] = traced(attrs["__call__"])
        return super().__new__(cls, name, bases, attrs)


class BaseUsecase(metaclass=TraceCallMeta):
    def __init__(
        self,
        db_session: AsyncSession | None = None,
        redis_connection: Redis | None = None,
        {% if use_nats %}
        nats_connection: HoloNats | None = None,
        {% endif %}
    ) -> None:
        self._db_session = db_session
        self._redis_connection = redis_connection
        {% if use_nats %}
        self._nats_connection = nats_connection
        {% endif %}

    @property
    def logger(self) -> logging.Logger:
        return logging.getLogger(f"{self.__module__}.{self.__class__.__name__}")
