# !!! DISCLAIMER !!! DO NOT EDIT THIS FILE
ARG PYTHON_VERSION=3.14
ARG OS_CODENAME=trixie


#############
## Base stage used by prod and dev.
#############
FROM ghcr.io/astral-sh/uv:python${PYTHON_VERSION}-${OS_CODENAME} AS base

ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy \
    UV_PYTHON_DOWNLOADS=never \
    UV_PROJECT_ENVIRONMENT=/venv

WORKDIR /app

COPY uv.lock pyproject.toml ./
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-install-project --no-dev

COPY . .

ENV PATH="/venv/bin:$PATH"
ENV PYTHONPATH=/app

#############
## Development stage
#############
FROM base AS dev

ARG HOST_GID=1000
ARG HOST_UID=1000
ARG HOST_USER="app"

RUN \
    useradd -m $HOST_USER \
    && usermod -o -u $HOST_UID $HOST_USER \
    && groupmod -o -g $HOST_GID $HOST_USER \
    && apt-get update && apt-get install -y --no-install-recommends curl sudo \
    && echo "$HOST_USER ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers \
    # Cleanup the image.
    && apt-get autoremove -y \
    && apt-get clean\
    && rm -rf /var/log/apt/* /tmp/* /var/tmp/* /var/lib/apt/lists/*

RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-install-project

USER $HOST_USER

#############
## Production stage
#############
FROM python:${PYTHON_VERSION}-slim-${OS_CODENAME} AS prod

WORKDIR /app

# Add curl, used in healthchecks.
RUN apt-get update && apt-get install -y --no-install-recommends curl \
    # Cleanup the image.
    && apt-get autoremove -y \
    && apt-get clean\
    && rm -rf /var/log/apt/* /tmp/* /var/tmp/* /var/lib/apt/lists/*

COPY --from=base --chown=65534:65534 /venv /venv
COPY --from=base --chown=65534:65534 /app /app

ENV PATH="/venv/bin:$PATH" \
    PYTHONPATH=/app

USER nobody

CMD ["uvicorn", "service.server:app", "--host", "0.0.0.0", "--forwarded-allow-ips", "*"]
