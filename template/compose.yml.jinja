# !!! DISCLAIMER !!! DO NOT EDIT THIS FILE
networks:
  default:
    name: {{ service_name }}
  holodeck:
    name: holodeck
    external: true

# Use this for local development.
# Production must use the image built with regular docker.
services:
  server: &server
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    build:
      context: .
      target: dev
      args:
        HOST_UID: "${HOST_UID:-1000}"
        HOST_GID: "${HOST_GID:-1000}"
        HOST_USER: "{{ service_name }}"
    container_name: {{ service_name }}
    networks:
      - default
      - holodeck
    env_file:
      - ".env.dev"
      - path: ".env.dev.override"
        required: false
    volumes:
      - ".:/app"
      - "./.bash_history:/home/{{ service_name }}/.bash_history"
      - "./.python_history:/home/{{ service_name }}/.python_history"
    command: python scripts/runserver.py
    {% if include_database or include_redis %}
    depends_on:
      {% if include_database %}
      db:
        condition: service_healthy
      {% endif %}
      {% if include_redis %}
      redis:
        condition: service_started
      {% endif %}
    {% endif %}
{% if include_database %}

  db:
    image: postgres:16
    container_name: "{{ service_name }}-psql"
    environment:
      - POSTGRES_DB={{ service_name }}-local
      - POSTGRES_USER={{ service_name }}
      - POSTGRES_PASSWORD=dbpassword
      - PGDATABASE={{ service_name }}-local
      - PGUSER={{ service_name }}
      - PGPASSWORD=dbpassword
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{service_name}} -d {{ service_name }}-local"]
      interval: 10s
      timeout: 5s
      retries: 5

  db-migrate:
    <<: *server
    container_name: {{ service_name }}-db-migrate
    command: alembic upgrade head
    profiles:
      - tools

  db-makemigrations:
    <<: *server
    container_name: {{ service_name }}-db-makemigrations
    command: alembic revision --autogenerate
    profiles:
      - tools
{% endif %}
{% if include_redis %}

  redis:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:v1.33.1
    ulimits:
      memlock: -1
    container_name: "{{ service_name }}-redis"
{% endif %}

  test:
    <<: *server
    container_name: {{service_name}}-test
    entrypoint: pytest -s --disable-pytest-warnings --ignore=service/monitoring/ --ignore=holo/ --tb=short
    command: service
    profiles:
      - tools
