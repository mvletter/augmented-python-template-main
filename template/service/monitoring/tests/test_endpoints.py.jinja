from datetime import datetime

from httpx import AsyncClient


async def test_ping(test_client: AsyncClient) -> None:
    """
    Test ping endpoint returns a 200 status code.
    """
    response = await test_client.get("/ping")

    assert response.status_code == 200
    assert response.json() == {"ok": True}


async def test_health(test_client: AsyncClient) -> None:
    """
    Test health endpoint returns up status for database and redis.
    """
    response = await test_client.get("/health")

    assert response.status_code == 200
    data = response.json()

    # Check timestamp can be parsed.
    datetime.strptime(data.pop("timestamp"), "%Y-%m-%dT%H:%M:%S.%f%z")

    expected_result = {
        "status": "up",
        "details": {},
    }
    {% if include_database %}
    expected_result["details"]["database"] = {"status": "up"}
    {% endif %}
    {% if include_redis %}
    expected_result["details"]["redis"] = {"status": "up"}
    {% endif %}
    assert data == expected_result
